// QEMU Configuration with Own Disks for Root, Home and Swap
// Copyright (C) 2020 by Thomas Dreibholz
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program.  If not, see <http://www.gnu.org/licenses/>.
//
// Contact: dreibh@simula.no

{
  "vm_name": "{{user `vm_name`}}",
  "output_directory": "{{user `vm_name`}}",
  "type": "qemu",
  "accelerator": "kvm",
  "headless": true,
  "format": "qcow2",
  "disk_interface": "virtio-scsi",
  "disk_cache": "unsafe",
  "disk_discard": "unmap",
  "net_device": "virtio-net",

  "cpus": 4,
  "memory": 4096,
  "disk_size": "{{user `vm_disk_root`}}",
  "disk_additional_size": [
    "{{user `vm_disk_home`}}M",
    "{{user `vm_disk_swap`}}M"
  ],
  "qemuargs": [
    [ "-bios", "OVMF.fd" ],
    [ "-vga", "qxl" ],

    // NOTE: NIC and SCSI controllers have to be defined here, to make sure
    // they are defined in the right order! By default, Packer would create
    // the SCSI controller first. Then, the NIC gets the next PCI slot =>
    // interface name is ens4, instead of ens3 as expected when the
    // VM is instantiated in OpenStack!
    // By defining the devices here, it is ensured that the NIC is named ens3.
    [ "-device", "virtio-net,netdev=user.0" ],
    [ "-device", "virtio-scsi-pci,id=scsi0" ],

    // NOTE: When defining the SCSI controller manually, it is also necessary
    // to manually write the disk definitions!
    [ "-device", "scsi-hd,bus=scsi0.0,drive=drive0" ],
    [ "-device", "scsi-hd,bus=scsi0.0,drive=drive1" ],
    [ "-device", "scsi-hd,bus=scsi0.0,drive=drive2" ],
    [ "-drive", "if=none,file={{user `vm_name`}}/{{user `vm_name`}},id=drive0,cache=unsafe,discard=unmap,format=qcow2" ],
    [ "-drive", "if=none,file={{user `vm_name`}}/{{user `vm_name`}}-1,id=drive1,cache=unsafe,discard=unmap,format=qcow2" ],
    [ "-drive", "if=none,file={{user `vm_name`}}/{{user `vm_name`}}-2,id=drive2,cache=unsafe,discard=unmap,format=qcow2" ]
  ]
}
